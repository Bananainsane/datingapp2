@page "/explore/{userId:int}"
@inject DatingApp.Data.DatingContext DB
@inject IJSRuntime JSRuntime
@inject DatingApp.Services.UserService UserService
@using DatingApp.Model.Enums
@using DatingApp.Models
@using Microsoft.EntityFrameworkCore
@using System.Linq
@rendermode InteractiveServer

<div class="flex items-center justify-center h-screen bg-gray-100 p-4">
    @if (profiles != null && profiles.Any())
    {
        <div class="w-full max-w-xl">
            @foreach (var profile in profiles.Take(1)) // Only take the first profile for display
            {
                <div class="relative w-full h-64 bg-cover bg-center rounded-xl overflow-hidden shadow-lg"
                    style="background-image: url('@profile.ImageUrl');" id="profileElementId">
                    <div class="w-full h-full flex flex-col justify-end bg-gradient-to-t from-black via-transparent to-transparent p-4">
                        <div class="text-white">
                            <p class="text-2xl md:text-3xl font-extrabold">@profile.UserName</p>
                            <p class="text-lg md:text-xl">@CalculateAge(profile.BirthDate) years old</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <p class="text-gray-500 text-2xl">No profiles available.</p>
    }
</div>

@code {
    [Parameter]
    public int userId { get; set; }

    private List<UserProfile> profiles = new List<UserProfile>();
    private UserProfile currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await DB.UserProfiles.FirstOrDefaultAsync(u => u.UserId == userId);
        await LoadProfiles();
    }

 private async Task LoadProfiles()
{
    // Assuming Gender is stored as an enum in the database and currentUser is correctly instantiated.
    Gender genderPreference = currentUser.Gender == Gender.Male ? Gender.Female : Gender.Male; // Default to opposite binary genders
    if (currentUser.Gender == Gender.Other)
    {
        // Assuming a strategy for 'Other', could be customized based on app requirements
        // Here we just randomly show profiles of any gender except 'Other'
        profiles = await DB.UserProfiles
            .Where(up => up.UserId != userId && up.Gender != Gender.Other)
            .OrderBy(r => Guid.NewGuid())
            .Take(10)
            .ToListAsync();
    }
    else
    {
        profiles = await DB.UserProfiles
            .Where(up => up.UserId != userId && up.Gender == genderPreference)
            .OrderBy(r => Guid.NewGuid())
            .Take(10)
            .ToListAsync();
    }
}


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("addSwipeListener", "profileElementId", DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public async Task SwipeRight()
    {
        // Process right swipe
        UpdateProfile();
    }

    [JSInvokable]
    public async Task SwipeLeft()
    {
        // Process left swipe
        UpdateProfile();
    }

    private void UpdateProfile()
    {
        if (profiles.Count > 1)
        {
            profiles.RemoveAt(0); // Remove the top profile
            InvokeAsync(StateHasChanged); // Update UI
        }
    }

    private int CalculateAge(DateTime? birthDate)
    {
        if (birthDate.HasValue)
        {
            DateTime now = DateTime.Today;
            int age = now.Year - birthDate.Value.Year;

            if (birthDate.Value.Date > now.AddYears(-age))
            {
                age--;
            }

            return age;
        }
        return 0;
    }
}
